(this.$WP=this.$WP||[]).push(["4fTSbk",(r,t)=>{"use strict";var e,a,o,i,n,s=(r,t,a,o,i,n,s,l)=>new Promise((_,c)=>{var g,d,u={geoId:r,attractionId:t,partnerName:s,productCode:a,tourGradeCode:o,tourDate:i,passengerMix:(g=n,d={},g.forEach((r,t)=>{d[t]=r}),d)},p=r=>{fetch(l?"/ShoppingCartApi/cart/add?isCartless=true":"/ShoppingCartApi/cart/add",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(u),credentials:"same-origin"}).then(r=>{if(r.ok)return r;throw Error(r.statusText)}).then(r=>r.json()).then(t=>{if("COMPLETE"!==t.polling_state)"IN_PROGRESS"===t.polling_state&&r<30?setTimeout(()=>p(r+1),1e3):c(Error(e("attractions.booking.errors.api_error")));else if(t.result){var a=document.getElementsByClassName("shopping-cart-size");switch(t.result.status){case"SUCCESS":a&&a.length>0&&(a[0].innerHTML=t.result.cart.summary.itemCount),_(t.result);break;case"DUPLICATE_ITEM":c(Error(e("attractions.cart.item_already_added_with_link",{0:"/ShoppingCart"})));break;case"ITEM_NOT_AVAILABLE":c(Error(e("attractions.cart.alert_not_available")));break;default:c(Error(e("attractions.booking.errors.api_error")))}}}).catch(()=>{c(Error(e("attractions.booking.errors.api_error")))})};p(1)});function l(r,t){return new Promise((a,o)=>{var i=n=>{fetch(`/AttractionBookingApi/product/${t?t+"/":""}${r}/dates`,{credentials:"same-origin"}).then(r=>{if(r.ok)return r;throw Error(r.statusText)}).then(r=>r.json()).then(r=>{"COMPLETE"!==r.polling_state?"IN_PROGRESS"===r.polling_state&&n<30?setTimeout(()=>i(n+1),1e3):o(Error(e("attractions.booking.errors.api_error"))):a(r.data)}).catch(()=>{o(Error(e("attractions.booking.errors.api_error")))})};i(1)})}var _=r=>{switch(r){case 1:return"ADULT";case 2:return"CHILD";case 3:return"INFANT";case 4:return"YOUTH";case 5:return"SENIOR";default:return"ADULT"}},c=(r,t,a)=>{if(a)return e("attractions.booking.common_n_traveler",{0:t});if(t<1)return"";switch(r){case 1:return e("attractions.booking.common_n_adult",{0:t});case 2:return e("attractions.booking.common_n_child",{0:t});case 3:return e("attractions.booking.common_n_infant",{0:t});case 4:return e("attractions.booking.common_n_youth",{0:t});case 5:return e("attractions.booking.common_n_senior",{0:t});default:return""}},g=r=>{var t,e=1===r.size;return 1===(t=Array.from(r,r=>c(r[0],r[1],e)).filter(r=>""!==r)).length?t[0]:t.join(", ")},d=r=>{var[t,e,a]=r.split("-").map(r=>parseInt(r,10));return new Date(t,e-1,a)},u=(r,t)=>((r,t)=>{var o=a.formatDate("week_date_long",r),i=g(t);return e("attractions.booking.tour_grade_unavailable_for_pax_date",{PAX:i,date:o})})(d(r),t),p=(r,t)=>o("attractions_apd_sold_out_message_with_additional_availability")?u(r,t):e("attractions.booking.tour_grade_unavailable_try_different");function m(r,t,a,i,n,s,l,_,c){var g=u(a,i),d=o("attractions_apd_sold_out_message_with_additional_availability");return new Promise((o,u)=>{var p=new URLSearchParams;p.append("tourDate",a),p.append("attrdate",(r=>r.replace(/-/g,"_"))(a)),p.append("ageBands",Array.from(i).map(r=>`${r[0]}:${r[1]}`).join(",")),l&&p.append("languageServices",l),p.append("locationId",JSON.stringify(s));var m=`/AttractionBookingApi/product/${n?n+"/":""}${r}/tour_grades?${p.toString()}`,b=r=>{fetch(m,{credentials:"same-origin"}).then(r=>{if(r.ok)return r;throw Error(r.statusText)}).then(r=>r.json()).then(a=>{if("COMPLETE"===a.polling_state){_&&_();try{var i=a.tour_grades.map(r=>({gradeCode:r.grade_code,sortOrder:r.sort_order,rnplEligibility:{eligible:!!r.rnpl_eligibility&&r.rnpl_eligibility.eligible,ineligibilityReasons:r.rnpl_eligibility?r.rnpl_eligibility.ineligibility_reasons:[]},gradeTitle:"DEFAULT"===r.grade_title?t:r.grade_title,gradeDescription:"DEFAULT"===r.grade_title?"":r.grade_description,priceFormatted:r.price_formatted,maxTravelersPerUnit:r.max_travelers_per_unit,ageBandsDisplay:r.age_bands.map(r=>r.band_summary),available:r.available,isMostPopularText:r.is_most_popular_text,langServices:null!==r.lang_services?Object.keys(r.lang_services):null}));i.some(r=>r.available)||(c&&c(),u(d?Error(g):Error(e("attractions.booking.tour_grade_unavailable_try_different")))),o(i)}catch(r){u(Error(e("attractions.booking.errors.api_error")))}}else"IN_PROGRESS"===a.polling_state&&r<30?setTimeout(()=>b(r+1),1e3):(c&&c(),d&&"NO_LONGER_AVAILABLE"===a.polling_state?u(Error(g)):u(Error(a.error_messages[0])))}).catch(()=>{u(Error(e("attractions.booking.errors.api_error")))})};b(1)})}var b=(r,t)=>t&&i(n,{module:t.module,action:t.action,context:t.context},r)||r,E=r=>e("exp_see_n_experiences_cap",{0:r.productCount});return r({getAvailableDates:l,getTourGrades:m}),[()=>{r({MAX_PAX_COUNT:15,POLLING_MAX_TRIES:30,POLLING_TIME_OUT:1e3,addToCart:s,addTrackingIfPresent:b,ageBandInputFrom:_,getAvailableDates:l,getCTAKey:E,getLocalDateFromString:d,getNumAgeBandText:c,getPAXText:g,getTourGrades:m,soldOutMessageGated:p})},[r=>(e=r.localize,a=r.globalize),r=>o=r.featureIsEnabled,r=>i=r.createElement,r=>n=r.ClickTracker]]},["535agn","-i3PJS","cDcdfi","Jk5sjx"]]);
