(this.$WP=this.$WP||[]).push(["bre2zH",(e,a)=>{"use strict";var t,n,i,r,o,l,c,d,s,u,p,m,v,_,h,k,f,g,C,b,I,N,y,S,P,A,x,D,w,O,T,M,F,E,G=()=>{var e=localStorage.getItem("TALocalStorageCurrentSessionId"),a=e&&JSON.parse(e);return a?a.value:(console.error("Attractions checkout Popup: Missing session Id"),null)},L=(e,a,t)=>{var n=G();if(n){var i="string"==typeof e?e:e.originalValue||e.encodedValue&&u(e.encodedValue);if(i){var r={lastSessionId:n,popupInfo:{productCode:i,tourGradeCode:a,dismissed:t},timestamp:Date.now(),ttl:T};p.set("attractionsCheckoutPopUpInfo",r,M)}}},B={productCode:null,cartItemId:null,trackAction:()=>{}},R=e=>e.filter(e=>e.count>0),U=e=>R(e).map(e=>e.bandSummaryFormatted).join(" | "),V=e=>new Map(R(e).map(e=>[e.bandId,e.count])),j=()=>fetch("/ShoppingCartApi/cart/detail?detailLevel=product&isCartless=true",{credentials:"same-origin"}).then(e=>{if(e.ok)return e;throw Error(JSON.stringify(e))}).then(e=>e.json()).catch(e=>({polling_state:"ERROR",result:null})),z=e=>e&&"IN_PROGRESS"!==e.polling_state,J=({productCode:e,tourGradeCode:a,pax:t,travelDate:n,onAvailCheckSuccess:i,onAvailCheckFailure:l})=>{var c,d,{detailedPricingAndAvailability:s,error:u}=N(e,t.map(e=>({ageBand:h(e.bandId),count:e.count})),n),p=null==s||null==(c=s.response)?void 0:c.tourGrades,m=p&&(d=a,p.some(e=>e&&e.available&&e.tourGradeCode===d));return r(()=>{p&&(m?i():l())},[m,l,i,p]),u?null:p?o("div",null,o(I,null),o("div",null,"is ",a," available? ",o("b",null,String(m))," ")):null},W=({productCode:e,locationId:a,tourGradeCode:t,pax:n,travelDate:i,onAvailCheckSuccess:o,onAvailCheckFailure:l})=>(r(()=>{k(e,t,i,V(n),null,a||0).then(e=>{((e,a)=>a.some(a=>a.available&&a.gradeCode===e))(t,e)&&o()}).catch(e=>{l()})},[a,l,o,n,e,t,i]),null),Y=e=>{var{onAvailCheckSuccess:a,onAvailCheckFailure:t}=e,[n,r]=i(!0),d=s("attractions_checkout_abandonment_pop_up_apds_check_availability"),u=l(()=>{r(!1)},[]),p=l(()=>{u(),a()},[u,a]),m=l(()=>{u(),t()},[u,t]),v=Object.assign({},e,{onAvailCheckSuccess:p,onAvailCheckFailure:m});return o(c,null,n&&o(I,null),d&&o(J,v),!d&&o(W,v))},q=({aprUrl:e,continueDisabled:a,viewDetailOnClick:t,continueOnClick:n})=>{var{localize:i}=P(),{viewportCategory:r}=d(y),{trackAction:l}=d(F);return o(c,null,o("div",{className:"_qqv0ubK"},i("attractions_checkout_abandonment_popup_avail_and_price_change")),o("div",{className:"_3V7b2aYh"},o("div",{onClick:()=>l("click_view_details")},o("a",{href:e,target:"_blank",onClick:t},o(x,{type:"secondary",fullwidth:"MOBILE"===r},i("attractions_checkout_abandonment_popup_view_details")))),o("div",{className:"_2Y8C5OLI",onClick:()=>l("click_continue_checkout")},o(x,{type:"original",onClick:n,fullwidth:"MOBILE"===r,disabled:a},i("attractions_checkout_abandonment_popup_continue_checkout")))))},H=()=>{var{localize:e}=P();return o("div",{className:"_1M6YmHEk"},o("span",null,e("attractions_checkout_abandonment_popup_header")))},K=({children:e,onClose:a})=>{var{viewportCategory:t}=d(y);return o(D,{onClose:a,header:o(H,null),closeIconColor:"TA_GRAY_3",vertical:"MOBILE"===t?{top:100}:{top:161},width:"MOBILE"===t?"100vw":750,bodyProps:{isFullBleed:!0}},e)},Q={width:360,height:240},X=({formattedPax:e,isInstantConfirmable:a,cancellationMessage:t})=>{var{localize:n}=P(),{viewportCategory:i}=d(y),r="MOBILE"===i||s("cx_brand_refresh_degreen")?"black":"accessibleGreen";return o(c,null,e&&o("div",null,"MOBILE"===i&&o("span",{className:"_3hmPhTNa"},o(w,{name:"users",color:r})),e),a&&o("div",null,o("span",{className:"_3hmPhTNa"},o(w,{name:"instant",color:r})),n("shopping_cart_instant_confirmation")),t&&o("div",null,o("span",{className:"_3hmPhTNa"},o(w,{name:"checkmark",color:r})),t))},Z=({title:e,url:a,imageUrl:t,tourGradeName:n,departureTime:i,formattedPax:l,price:c,cancellationMessage:s})=>{var{viewportCategory:u}=d(y),{trackAction:p}=d(F);return r(()=>{p("impression_lightbox")},[p]),o("div",{className:"_2gh-FBaM"},o("div",{className:"_3ZDO3fTK"},o("div",{className:"_1604WLWt",onClick:()=>{p("click_photo")}},o("a",{href:a,target:"_blank"},o(O,{sources:[Object.assign({},Q,{url:t||""})],alt:e,height:"100px",width:"100px",borderRadius:"2px"}))),o("div",null,o("a",{href:a,target:"_blank"},o("div",{className:"Q8WpQShT",onClick:()=>{p("click_title")}},e)),n&&o("div",{className:"yfoK9rYx"},n),i&&o("div",null,i),"MOBILE"!==u&&o(X,{formattedPax:l,cancellationMessage:s}))),o("div",{className:"_3tX30uXw"},o("div",null,"MOBILE"===u&&o(X,{formattedPax:l,cancellationMessage:s})),o("div",{className:"SLUgsoxx"},c)))},$=()=>{var[e,a]=i(!1);return o(c,null,o("div",{className:"_3x-gcvtJ"},o(w,{name:"special-offer-45deg",color:"taNotificationRed",fontSize:20}),o(A,{id:"attractions_checkout_abandonment_popup_special_offer_title_unescaped",args:{specialOfferClass:"_17unL2--",promoCode:"SAVETODAY",promoCodeClass:"_8FkdrQ5r"}}),"Â ",o("span",{className:"_1aa4z0hC",onClick:()=>a(e=>!e)},o(S,{id:"attractions_checkout_abandonment_popup_special_offer_see_terms"})),"."),e&&o("div",{className:"_3CLW1Pv2"},o(S,{id:"attractions_checkout_abandonment_popup_special_offer_terms_feb_2020"})))},ee=({productId:e,productCode:a,tourGradeCode:t,pax:n,travelDate:c,travelDateUI:u,displayedPrice:m,productDisplay:v,cancellationMessage:h,isAvailable:k})=>{var I,{trackAction:N}=d(F),[y,S]=i(!1),[P,A]=i(!1),[x]=g({query:E,variables:{productId:e},requestPolicy:"network-only"}),{fetching:D,data:w}=x,O=null==w||null==(I=w.attractionProducts)?void 0:I[0],T=null==O?void 0:O.url;r(()=>{var e,n,i;!D&&w&&S((e={productCode:a,tourGradeCode:t},!(i=(n=p.get("attractionsCheckoutPopUpInfo"))&&n.popupInfo)||i.productCode!==e.productCode||i.tourGradeCode!==e.tourGradeCode||!i.dismissed))},[w,D,a,t]);var M=l(()=>{setTimeout(()=>{window.location="/shoppingCartCheckout?isCartless=true"},300)},[]),G=l(()=>{T&&(C(a,n.map(({bandId:e,count:a})=>({bandId:e,count:a})),f(c),((e,a)=>_(e,V(a)))(c,n)),window.location=T)},[T,n,a,c]),B=l(e=>{L(a,t,e)},[a,t]),R=l(()=>{N("click_exit"),S(!1),B(!0)},[B,N]),j=b(()=>{B(!1)});if(!O)return null;var z,{name:J,url:W}=O;return y&&!!J&&!!W&&o(K,{onClose:()=>R()},o("div",{ref:j,className:"_3QZBleNa"},s("attractions_checkout_abandonment_pop_up_with_promo")&&o($,null),o(Z,{title:J,url:W,imageUrl:O.imageUrl,tourGradeName:v.gradeName,departureTime:(z=[v.gradeDepartureTime,u],z.filter(Boolean).join(" | ")),formattedPax:U(v.passengerMix),price:m,cancellationMessage:h}),P&&o(Y,{productCode:a,locationId:O.activityId,tourGradeCode:t,pax:n,travelDate:c,onAvailCheckSuccess:M,onAvailCheckFailure:G}),o(q,{aprUrl:W,viewDetailOnClick:()=>{B(!0)},continueOnClick:()=>A(!0),continueDisabled:!k})))},ae=()=>{var e=v(),{status:a,cartItem:t}=((e,a)=>{var t,o,[l,c]=i("Fetching"),[d,s]=i(!1);r(()=>{fetch("/ShoppingCartApi/cart/summary?isCartless=true",{credentials:"same-origin"}).then(e=>{if(e.ok)return e;throw Error(JSON.stringify(e))}).then(e=>e.json()).then(e=>{0===e.itemCount?c("NoItem"):s(!0)}).catch(e=>{console.error("failed fetching cart summary",e),c("Failed")}).finally(()=>{})},[void 0]);var u,p,v,_,h=(({pollingCall:e,completeResponsePredicate:a,pollInterval:t=1e3,maxTries:o=10,pause:l=!1})=>{var c=n(null),d=n(0),[s,u]=i({fetching:!l}),[p,m]=i(l);return r(()=>{var e=s.data&&a(s.data);!p||l||e||(m(!1),u({fetching:!0}))},[a,s.data,l,p]),r(()=>{if(p)return()=>{};var n=()=>{if(d.current<o){d.current+=1;var i=d.current;e().then(e=>{d.current===i&&a(e)&&(u({fetching:!1,data:e}),clearTimeout(c.current))}).catch(e=>{}),d.current,c.current=setTimeout(n,t)}else u({fetching:!1})};return n(),()=>{c.current&&clearTimeout(c.current)}},[p]),s})({pollingCall:j,completeResponsePredicate:z,pollInterval:2e3,maxTries:5,pause:!d}),{fetching:k,data:f}=h,g=m(k),C=!k&&(null==f||null==(t=f.result)?void 0:t.cart)||null,b=(null==C||null==(o=C.items)?void 0:o[0])||null;return r(()=>{g&&!k&&c(b?"Success":"Failed")},[k,g,b,void 0]),{status:l,cartItem:C&&b&&(u=b,p=C,v=p.notifications.find(({cartItemId:e})=>e===u.id),_=v&&v.notificationType||null,Object.assign({},u,{notificationType:_}))}})(),l=m(a),[c,d]=i(B);if(r(()=>{if("Fetching"===l&&"Success"===a&&t){var{productCode:n}=t.productParameters,i=t.id,r=s("t11430_checkout_abandonment_pop_up_test_with_promo");d({productCode:n,cartItemId:i,trackAction:a=>{e({module:"checkout_abandonment_box",action:a,context:[n,i,String(r)].join(" | ")})}})}},[t,l,e,a]),!t)return null;var u=t.productParameters,{productId:p,productCode:_,tourGradeCode:h,checkinDate:k,checkinDateUI:f,cancellationCondition:g}=u,C=t.display,{passengerMix:b}=C,I=t.availability.priceFormatted;return o(F.Provider,{value:c},"PAST_CHECKIN_DATE"!==t.notificationType&&o(ee,{productId:p,productCode:_,tourGradeCode:h,pax:b,travelDate:k,travelDateUI:f,displayedPrice:I,cancellationMessage:g,productDisplay:C,isAvailable:!t.notificationType}))},te=()=>{var[e,a]=i(!1),t=s("attractions_checkout_abandonment_pop_up_with_promo")||s("attractions_checkout_abandonment_pop_up");return r(()=>{var e;(!(e=p.get("attractionsCheckoutPopUpInfo"))||e.lastSessionId!==G()||Date.now()>e.timestamp+e.ttl)&&a(t)},[t]),e&&o(ae,null)};return[()=>{T=72e5,M=2592e6,F=t(B),(E=JSON.parse('{"kind":"Document","definitions":[{"kind":"OperationDefinition","operation":"query","name":{"kind":"Name","value":"CartItemAttractionProductInfo"},"variableDefinitions":[{"kind":"VariableDefinition","variable":{"kind":"Variable","name":{"kind":"Name","value":"productId"}},"type":{"kind":"NonNullType","type":{"kind":"NamedType","name":{"kind":"Name","value":"Int"}}},"directives":[]}],"directives":[],"selectionSet":{"kind":"SelectionSet","selections":[{"kind":"Field","name":{"kind":"Name","value":"attractionProducts"},"arguments":[{"kind":"Argument","name":{"kind":"Name","value":"attractionProductIds"},"value":{"kind":"ListValue","values":[{"kind":"Variable","name":{"kind":"Name","value":"productId"}}]}}],"directives":[],"selectionSet":{"kind":"SelectionSet","selections":[{"kind":"Field","name":{"kind":"Name","value":"name"},"arguments":[],"directives":[]},{"kind":"Field","name":{"kind":"Name","value":"imageUrl"},"arguments":[],"directives":[]},{"kind":"Field","name":{"kind":"Name","value":"url"},"arguments":[],"directives":[]},{"kind":"Field","name":{"kind":"Name","value":"activityId"},"arguments":[],"directives":[]}]}}]}}],"loc":{"start":0,"end":174}}')).__key=0xcc3723961415,E.loc.source={body:"cc3723961415"},e("default",te),e("setPopupInfo",L)},[e=>(t=e.createContext,n=e.useRef,i=e.useState,r=e.useEffect,o=e.createElement,l=e.useCallback,c=e.Fragment,d=e.useContext),e=>s=e.featureIsEnabled,e=>u=e.default,e=>p=e.default,e=>m=e.default,e=>v=e.useGARecorder,e=>(_=e.soldOutMessageGated,h=e.ageBandInputFrom,k=e.getTourGrades,f=e.getLocalDateFromString),e=>g=e.useQuery,e=>C=e.writeMessage,e=>b=e.useOnVisible,e=>I=e.LoadingSpinner,e=>N=e.useDetailedPricingAndAvailability,e=>y=e.Device,e=>(S=e.default,P=e.useLocalize,A=e.UnsafeLocalize),e=>x=e.default,e=>D=e.default,e=>w=e.default,e=>O=e.ResponsiveImage]]},["cDcdfi","-i3PJS","dROhDJ","jaCyxS","vWxBAe","fsml46","4fTSbk","5X2em-","EYH0wr","BLrxBS","V08PS7","hg9k0-","2R4xv2","0DsHEV","PCbs_l","DjNvou","OMqGt0","KwOV1Z"]]);
